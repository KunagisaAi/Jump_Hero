local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

-- 平台原始和变色后的颜色
local PLATFORM_COLOR = Color3.fromRGB(54, 165, 71)
local PLATFORM_USED_COLOR = Color3.fromRGB(163, 162, 165)
local NEW_PLATFORM_SIZE = Vector3.new(20, 1, 20)
local MIN_DIST = 20
local MAX_DIST = 100
local SAFE_RADIUS = 20
local MAX_ATTEMPTS = 20

-- 玩家最近生成的平台记录
local playerPlatformHistory = {}

-- 新增：玩家无敌时间记录
local lastDamageTime = {}

-- 判断是否为目标平台
local function isTargetPlatform(part)
	return part:IsA("Part") and part.Color == PLATFORM_COLOR
end

-- 判断是否为任意平台（新旧都算）
local function isAnyPlatform(part)
	return part:IsA("Part") and (part.Color == PLATFORM_COLOR or part.Color == PLATFORM_USED_COLOR)
end

-- 检查新平台位置周围是否安全
local function isSafePosition(pos)
	for _, part in Workspace:GetChildren() do
		if isAnyPlatform(part) then
			local dist = (part.Position - pos).Magnitude
			if dist < SAFE_RADIUS then
				return false
			end
		end
	end
	return true
end

-- 生成新平台，只能往东、西、北三个方向，且Y轴不能低于原平台
local function spawnPlatform(originPart, player)
	local attempt = 0
	local newPos = nil
	local directions = {
		Vector3.new(1, 0, 0),   -- 东
		Vector3.new(-1, 0, 0),  -- 西
		Vector3.new(0, 0, 1),   -- 北
	}
	while attempt < MAX_ATTEMPTS do
		local dir = directions[math.random(1, 3)]
		local dist = math.random(MIN_DIST, MAX_DIST)
		local offset = dir * dist
		-- 新平台Y轴为原平台Y轴 + 平台厚度，保证不低于原平台
		local newY = originPart.Position.Y + math.max(NEW_PLATFORM_SIZE.Y/2 + originPart.Size.Y/2, 0)
		newPos = Vector3.new(originPart.Position.X + offset.X, newY, originPart.Position.Z + offset.Z)
		if isSafePosition(newPos) then
			break
		end
		attempt = attempt + 1
	end
	if attempt < MAX_ATTEMPTS then
		local newPart = Instance.new("Part")
		newPart.Size = NEW_PLATFORM_SIZE
		newPart.Position = newPos
		newPart.Anchored = true
		newPart.Color = PLATFORM_COLOR
		newPart.Parent = Workspace
		newPart.Name = "JumpPlatform"
		-- 记录玩家平台历史
		if player then
			if not playerPlatformHistory[player] then
				playerPlatformHistory[player] = {}
			end
			local history = playerPlatformHistory[player]
			-- 保持最多两个历史
			if #history >= 2 then
				history[1] = history[2]
				history[2] = newPart
			elseif #history == 1 then
				history[2] = newPart
			else
				history[1] = newPart
			end
		end
	end
end

-- 在指定角色周围生成新平台（只能东、西、北方向，Y轴不低于角色）
local function spawnPlatformAroundCharacter(character, player)
	local hrp = character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	local directions = {
		Vector3.new(1, 0, 0),   -- 东
		Vector3.new(-1, 0, 0),  -- 西
		Vector3.new(0, 0, 1),   -- 北
	}
	local dir = directions[math.random(1, 3)]
	local dist = 40
	local offset = dir * dist
	local newY = hrp.Position.Y + math.max(NEW_PLATFORM_SIZE.Y/2 + hrp.Size.Y/2, 0)
	local newPos = Vector3.new(hrp.Position.X + offset.X, newY, hrp.Position.Z + offset.Z)
	-- 确保不会和角色重叠
	if isSafePosition(newPos) then
		local newPart = Instance.new("Part")
		newPart.Size = NEW_PLATFORM_SIZE
		newPart.Position = newPos
		newPart.Anchored = true
		newPart.Color = PLATFORM_COLOR
		newPart.Parent = Workspace
		newPart.Name = "JumpPlatform"
		-- 记录玩家平台历史
		if player then
			if not playerPlatformHistory[player] then
				playerPlatformHistory[player] = {}
			end
			local history = playerPlatformHistory[player]
			if #history >= 2 then
				history[1] = history[2]
				history[2] = newPart
			elseif #history == 1 then
				history[2] = newPart
			else
				history[1] = newPart
			end
		end
	end
end

-- 清空所有已生成的平台
local function clearAllPlatforms()
	for _, part in Workspace:GetChildren() do
		if isAnyPlatform(part) and part.Name == "JumpPlatform" then
			part:Destroy()
		end
	end
end

-- 绑定平台触发逻辑
local function bindPlatform(part)
	part.Touched:Connect(function(hit)
		local character = hit.Parent
		local humanoid = character:FindFirstChild("Humanoid")
		if humanoid then
			-- 检查是否为玩家角色且平台颜色为目标色
			if part.Color == PLATFORM_COLOR then
				-- 找到玩家对象
				local player = Players:GetPlayerFromCharacter(character)
				spawnPlatform(part, player)
				part.Color = PLATFORM_USED_COLOR
			end
		end
	end)
end

-- 初始化：遍历所有平台并绑定
for _, part in Workspace:GetChildren() do
	if isTargetPlatform(part) then
		bindPlatform(part)
	end
end

-- 监听新平台加入
Workspace.ChildAdded:Connect(function(child)
	if isTargetPlatform(child) then
		bindPlatform(child)
	end
end)

-- 新增：监听玩家重生，清空平台并生成新平台
local function onCharacterAdded(character, player)
	-- 清空所有平台
	clearAllPlatforms()
	-- 在角色周围生成一个新平台
	spawnPlatformAroundCharacter(character, player)
end

Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(character)
		onCharacterAdded(character, player)
	end)
end)

for _, player in Players:GetPlayers() do
	player.CharacterAdded:Connect(function(character)
		onCharacterAdded(character, player)
	end)
end

-- 新增功能：Baseplate触发扣血与传送
local Baseplate = Workspace:FindFirstChild("Baseplate")
if Baseplate then
	Baseplate.Touched:Connect(function(hit)
		local character = hit.Parent
		local humanoid = character:FindFirstChild("Humanoid")
		if humanoid then
			local player = Players:GetPlayerFromCharacter(character)
			if player then
				-- 无敌判定
				local now = os.clock()
				if not lastDamageTime[player] or (now - lastDamageTime[player] > 1) then
					lastDamageTime[player] = now
					-- 扣血
					humanoid.Health = humanoid.Health - 40
					-- 只有玩家未死亡才传送
					if humanoid.Health > 0 then
						local history = playerPlatformHistory[player]
						if history and history[1] and history[1].Parent == Workspace then
							local hrp = character:FindFirstChild("HumanoidRootPart")
							if hrp then
								hrp.CFrame = CFrame.new(history[1].Position + Vector3.new(0, 5, 0))
							end
						end
					end
				end
				-- 如果在无敌时间内则不扣血也不传送
			end
		end
	end)
end

